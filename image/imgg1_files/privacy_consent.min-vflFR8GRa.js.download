define(["require","exports","tslib","modules/core/i18n","proto_utils/unpack","modules/core/exception","modules/clean/web_timing_logger","dropbox/proto/js_init_data/privacy_consent/privacy_consent","modules/clean/marketing_tracker","modules/clean/ux_analytics/dispatch_custom_event","modules/clean/ux_analytics/lazy_ux_analytics","modules/clean/privacy_consent_stats"],(function(e,t,o,i,n,r,a,s,c,l,u,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initialize_module=t.moduleInit=t.PrivacyConsentPlatform=t.PrivacyConsentPlatformSingleton=void 0,l=o.__importStar(l);var p,h,f="dropbox.com".split(".").length-1,m=i.intl.formatMessage({id:"yF4LPz",defaultMessage:"Manage cookies"}),g=i.intl.formatMessage({id:"t0O/69",defaultMessage:"Cookie policy"});(function(e){e.StrictlyNecessary="strictly necessary",e.MarketingAdvertising="general marketing and advertising",e.Analytics="analytics",e.PerformanceFunctionality="performance and functionality",e.SocialMediaAdvertising="social media advertising",e.AllCookies="all"})(p||(p={})),(function(e){e[e.OptIn=1]="OptIn"})(h||(h={}));var C=(function(){function n(){var i=this;return this.manageCookiesSet=!1,this.manageCookiesInjected=!1,this.floatingButtonVisible=!1,this.bannerVisible=!1,this.optionsButtonLoaded=!1,this.localeSelector=null,this.ttiTimeout=5e3,this.disableFloatingButton=!1,this.isInIframe=!1,this.isFooterLoading=!1,this.loadChatModule=function(){return i.chatLoadPromise?i.chatLoadPromise:(i.chatLoadPromise=a.waitForTTI({timeoutMS:i.ttiTimeout}).then((function(){return new Promise((function(t,o){e(["modules/clean/chat/chat_client"],t,o)})).then(o.__importStar)})),i.chatLoadPromise)},this.receiveMessage=function(e){var t=e.data;if(e.source===i.iframeEl.contentWindow)switch(t.message_type){case"BODY_CONTENT_CHANGE":i.onBodyContentChange(t);break;case"BANNER_RESIZE":i.onBannerResize(t);break;case"DISPLAY_BUTTON":i.onDisplayButton(t);break;case"PRIOR_CONSENT":i.onPriorConsent(t);break;case"CONSENT_CHANGED":case"CONSENT_WITHDRAWN":i.onConsentChanged(t);break;case"CONSENT_DECLINED":i.onConsentDeclined(t);break;case"SCRIPT_LOADED":i.onScriptLoaded(t);break;case"SCRIPT_LOAD_ERROR":i.onScriptLoadError(t);break;case"TOGGLE_BUTTON_MINIMIZE":i.onToggleButtonMinimize(t.buttonMinimized)}},this.disableFloatingButton=this.isNoButtonPage(),this.isInIframe=window.self!=window.top,t.PrivacyConsentPlatform?t.PrivacyConsentPlatform:this}return n.prototype.init=function(e){var t,o=this;this.config=e,this.updateTealiumDataLayer(),!e.iframeOrigin||this.iframeEl||document.getElementById("consent-iframe")||this.isInIframe||(this.iframeOrigin="https://"+e.iframeOrigin,this.iframeSrc="https://"+e.iframeOrigin+window.location.hash,this.iframeStartTime=new Date,this.iframeEl=this.createIframe(),null===(t=this.iframeEl)||void 0===t||t.addEventListener("load",(function(){o.handleIframeLoad(o.iframeStartTime,e.iframeOrigin)})),window.addEventListener("message",this.receiveMessage,!1))},n.prototype.handleIframeLoad=function(e,t){var o=this,i=(new Date).valueOf()-e.valueOf();this.logToUXA("privacyConsentIframeLoaded",{total_time:i.toString(),iframe_uri:t}),d.PrivacyConsentStats.logDuration(d.PrivacyConsentAmpMetrics.CROWNPEAK_LOAD_LATENCY,{},i),d.PrivacyConsentStats.logCounter(d.PrivacyConsentAmpMetrics.EVENTS,{eventName:d.PrivacyConsentEvent.SETUP_REENTRY_START}),a.waitForTTI({timeoutMS:this.ttiTimeout}).then((function(){o.sendCountryCode(),o.setupSettingsReEntry(),o.addLocaleSelectorMargin(),o.logPrivacyConsentResult()}))},n.prototype.onFooterLoaded=function(){var e=this;a.waitForTTI({timeoutMS:this.ttiTimeout}).then((function(){e.setupSettingsReEntry(),e.addLocaleSelectorMargin()}))},n.prototype.setupSettingsReEntry=function(){!this.config||this.manageCookiesSet||this.manageCookiesInjected||(this.setManageCookies(),this.injectManageCookies(),this.maybeUseFloatingButton())},n.prototype.isNoButtonPage=function(){return["/transfer"].includes(window.location.pathname)},n.prototype.maybeUseFloatingButton=function(){this.disableFloatingButton||!this.iframeEl||this.manageCookiesSet||this.manageCookiesInjected||this.isFooterLoading||this.sendShowFloatingButton()},n.prototype.createIframe=function(){var e=document.createElement("iframe");return e.src=this.iframeSrc,e.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-forms"),e.setAttribute("class","consent-iframe"),e.setAttribute("id","consent-iframe"),e.setAttribute("allowTransparency","true"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("hidden","true"),e.setAttribute("scrolling","no"),e.setAttribute("title",i.intl.formatMessage({id:"ulDVPi",defaultMessage:"Dropbox Consent"})),e.setAttribute("tabindex","1"),document.body.insertBefore(e,document.body.childNodes[0]),e},n.prototype.openOptionsDialog=function(){var e,t;null===(t=null===(e=this.iframeEl)||void 0===e?void 0:e.contentWindow)||void 0===t||t.postMessage({message_type:"OPEN_OPTIONS_DIALOG"},this.iframeOrigin)},n.prototype.addLocaleSelectorMargin=function(){if(this.iframeEl&&this.bannerVisible){this.localeSelector||(this.localeSelector=document.getElementById("locale-container")||document.querySelector(".warp-locale-selector-plank"));var e=parseInt(this.iframeEl.height,10)||0;if(this.localeSelector){this.localeSelector.style.removeProperty("margin-bottom");var t=parseInt(window.getComputedStyle(this.localeSelector).marginBottom,10)||0;this.localeSelector.style.marginBottom=e+t+"px"}this.loadChatModule().then((function(t){var o=t.ChatClientSingleton;o.isSetup()&&o.setCookieBannerInfo(!0,e)}))}},n.prototype.removeLocaleSelectorMargin=function(){this.localeSelector&&this.localeSelector.style.removeProperty("margin-bottom"),this.loadChatModule().then((function(e){var t=e.ChatClientSingleton;t.isSetup()&&t.setCookieBannerInfo(!1,0)}))},n.prototype.sendShowFloatingButton=function(){var e,t;null===(t=null===(e=this.iframeEl)||void 0===e?void 0:e.contentWindow)||void 0===t||t.postMessage({message_type:"SHOW_FLOATING_BUTTON"},this.iframeOrigin),this.floatingButtonVisible=!0},n.prototype.setIframeHeight=function(e){this.iframeEl.height=e},n.prototype.setIframeWidth=function(e){this.iframeEl.width=e},n.prototype.getCookieStr=function(e){try{return String(document.cookie||"").split(";").map((function(e){return e.split("=")})).map((function(e){return[e[0],e.slice(1).join(";")].map((function(e){return e.replace(/^[ \t]+|[ \t]+$/g,"")}))})).reduce((function(e,t){var i,n=t[0],r=t[1];return o.__assign(o.__assign({},e),((i={})[n]=r,i))}),Object.create({}))[e]||""}catch(e){return""}},n.prototype.getCurrentCookieObj=function(){var e=this.getCookieStr("__Secure-dbx_consent");if(e)try{return JSON.parse(e)}catch(t){return r.reportException({err:new Error("Consent cookie could not be parsed"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_str:e}}),null}return{}},n.prototype.createShadowCookieValue=function(e,t){var o=this.getCurrentCookieObj(),i=!!o.userInteracted,n=!(!i&&t)&&o.consentDate?new Date(o.consentDate):new Date,r=new Date(n);return r.setMonth(n.getMonth()+6),{consentType:h.OptIn,consentDate:n.toISOString(),expireDate:r.toISOString(),consentMonths:6,categories:e,userInteracted:i||t,numDots:f}},n.prototype.bakeCookie=function(e){var t,o=((t={})["__Secure-dbx_consent"]=JSON.stringify(e).replace(/[;]|[^ -~]/g,(function(e){return"\\u"+(65536+e.charCodeAt(0)).toString(16).substr(1)})),t.domain="dropbox.com",t.path="/",t.expires=new Date(e.expireDate).toUTCString(),t.samesite="lax",t.secure="",t),i=Object.keys(o).map((function(e){return o[e]?e+"="+o[e]:""+e}));document.cookie=i.join(";")},n.prototype.updateTealiumDataLayer=function(){var e=this.getCurrentCookieObj(),t=null==e?void 0:e.categories,i=Object.keys(p),n=[];t&&(t[p.AllCookies]?n=o.__spreadArrays(i):i.forEach((function(e){t[p[e]]&&n.push(e)}))),c.MarketingTracker.pushWithDefaults({consent_categories:n.join(",")})},n.prototype.reloadPage=function(){window.location.reload(!0)},n.prototype.hasUserInteracted=function(){var e;return!!(null===(e=this.getCurrentCookieObj())||void 0===e?void 0:e.userInteracted)},n.prototype.havePreferencesChanged=function(e){var t=this.getCurrentCookieObj();if(t)try{var o=JSON.stringify(t.categories);return JSON.stringify(e)!==o}catch(e){return r.reportException({err:new Error("Consent cookie could not be parsed"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_str:this.getCookieStr("__Secure-dbx_consent")}}),!1}return!0},n.prototype.mapCookies=function(e){var t={};for(var o in e)if(e.hasOwnProperty(o)){var i=o.toLowerCase();Object.values(p).includes(i)?t[i]=e[o]:r.reportException({err:new Error("Invalid cookie category id"),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"],exc_extra:{cookie_id:i}})}return t},n.prototype.onBodyContentChange=function(e){var t,o,i,n,r,a=e.bannerVisible,s=e.dialogVisible,c=e.optionsButtonVisible,l=e.optionsButtonLoaded,u=!a&&!s&&!c;if(this.bannerVisible=a,null===(t=this.iframeEl)||void 0===t||t.classList.toggle("banner-visible",a),null===(o=this.iframeEl)||void 0===o||o.classList.toggle("dialog-open",s),null===(i=this.iframeEl)||void 0===i||i.classList.toggle("button-enabled",c),l&&!this.optionsButtonLoaded&&(this.optionsButtonLoaded=!0,this.setupSettingsReEntry()),u?(this.setIframeHeight("0"),this.setIframeWidth("0")):null===(n=this.iframeEl)||void 0===n||n.removeAttribute("hidden"),a?(this.addLocaleSelectorMargin(),this.hasUserInteracted()||this.bakeCookie(this.createShadowCookieValue(this.mapCookies({}),!1))):this.removeLocaleSelectorMargin(),c){var d="true"===sessionStorage.getItem("cookie-settings-minimized");null===(r=this.iframeEl)||void 0===r||r.classList.toggle("prev-collapsed",d)}else this.clearIframeMinimizeClass()},n.prototype.onBannerResize=function(e){e.bannerHeight&&e.bannerHeight!==this.iframeEl.height&&(this.setIframeHeight(e.bannerHeight),this.addLocaleSelectorMargin())},n.prototype.onDisplayButton=function(e){!this.manageCookiesSet&&e.buttonHeight&&e.buttonWidth&&(this.setIframeHeight(e.buttonHeight),this.setIframeWidth(e.buttonWidth))},n.prototype.onPriorConsent=function(e){var t=this.mapCookies(e.categories),o=this.havePreferencesChanged(t);this.hasUserInteracted()&&!o||(this.bakeCookie(this.createShadowCookieValue(this.mapCookies(e.categories),!0)),this.reloadPage())},n.prototype.onConsentChanged=function(e){var t=this.mapCookies(e.categories),o=this.havePreferencesChanged(t);this.bakeCookie(this.createShadowCookieValue(t,!0)),o&&this.reloadPage()},n.prototype.onConsentDeclined=function(e){this.bakeCookie(this.createShadowCookieValue(this.mapCookies(e.categories),!0))},n.prototype.onScriptLoaded=function(e){this.logToUXA("privacyConsentScriptLoaded",{script_id:e.scriptId,script_url:e.scriptUrl})},n.prototype.onScriptLoadError=function(e){this.logToUXA("privacyConsentScriptLoadError",{script_id:e.scriptId,script_url:e.scriptUrl}),r.reportException({err:new Error("Privacy consent module is not visible on page "+window.location.pathname),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"]})},n.prototype.clearIframeMinimizeClass=function(){var e;null===(e=this.iframeEl)||void 0===e||e.classList.remove("prev-collapsed","collapsed","expanded")},n.prototype.onToggleButtonMinimize=function(e){var t,o,i,n;null===(t=this.iframeEl)||void 0===t||t.classList.remove("prev-collapsed"),null===(o=this.iframeEl)||void 0===o||o.classList.toggle("collapsed",e),null===(i=this.iframeEl)||void 0===i||i.classList.toggle("expanded",!e),sessionStorage.setItem("cookie-settings-minimized",(null===(n=this.iframeEl)||void 0===n?void 0:n.classList.contains("collapsed"))?"true":"false")},n.prototype.sendCountryCode=function(){var e,t,o;(null===(e=this.config)||void 0===e?void 0:e.countryCode)&&(null===(o=null===(t=this.iframeEl)||void 0===t?void 0:t.contentWindow)||void 0===o||o.postMessage({message_type:"COUNTRY_CODE",country_code:this.config.countryCode},this.iframeOrigin))},n.prototype.logToUXA=function(e,t){var o={detail:{eventType:e,extra:t}};u.runAfterUxaListening((function(){l.dispatchCustomEvent("privacy_consent_custom_event",o)}))},n.prototype.onClickManageCookies=function(e){e.preventDefault(),this.openOptionsDialog()},n.prototype.findManageCookies=function(){return document.querySelector('a[href*="#manage-cookies"]')||null},n.prototype.findCookiePolicy=function(e){return(null==e?void 0:e.querySelector('a[href*="/terms/cookies"],a[href*="/accounts-billing/security/cookies"]'))||null},n.prototype.getLinkWrapper=function(e){return e.closest("li")},n.prototype.createManageCookies=function(e){var t=this,o=this.getLinkWrapper(e);if(o){var i=o.cloneNode(),n=document.createElement("a");return n.textContent=m,n.setAttribute("class",e.className),n.setAttribute("href","#manage-cookies"),n.onclick=function(e){return t.onClickManageCookies(e)},i.appendChild(n),i}return null},n.prototype.findFooter=function(){var e=["pre-footer","matrix__footer","footer-cta","footer-secondary-cta","cta-footer"],t=["div","section","footer"],o=Array.from(document.querySelectorAll(["footer",'[id="footer"]','[class="footer"]','[class^="footer "]','[class*=" footer "]','[class$=" footer"]','[id*="-footer"]','[id^="footer-"]','[id*="_footer"]','[id^="footer_"]','[class*="-footer"]','[class^="footer-"]','[class*="_footer"]','[class^="footer_"]'].join(","))).filter((function(o){return!e.some((function(e){return o.className.includes(e)}))&&t.includes(o.tagName.toLowerCase())}));return o.length?o[0]:null},n.prototype.injectManageCookies=function(){if(!this.manageCookiesSet&&!this.manageCookiesInjected){var e=this.findFooter(),t=e?this.findCookiePolicy(e):null;if(!this.manageCookiesSet&&t){var o=this.createManageCookies(t),i=this.getLinkWrapper(t);o&&i&&(i.insertAdjacentElement("afterend",o),this.renameCookiePolicyLink(t),this.manageCookiesInjected=!0)}}},n.prototype.renameCookiePolicyLink=function(e){e.textContent=g},n.prototype.setManageCookies=function(){var e=this;if(!this.manageCookiesSet&&!this.manageCookiesInjected){var t=this.findManageCookies();t&&(t.setAttribute("href","#manage-cookies"),t.onclick=function(t){return e.onClickManageCookies(t)},this.manageCookiesSet=!0)}},n.prototype.logPrivacyConsentResult=function(){var e=this.manageCookiesSet||this.manageCookiesInjected||this.floatingButtonVisible||this.bannerVisible,t=e?d.PrivacyConsentEvent.SETUP_REENTRY_SUCCESS:d.PrivacyConsentEvent.SETUP_REENTRY_FAILURE;d.PrivacyConsentStats.logCounter(d.PrivacyConsentAmpMetrics.EVENTS,{event_name:t}),e||r.reportException({err:new Error("Privacy consent module is not visible on page "+window.location.pathname),severity:r.SEVERITY.NONCRITICAL,tags:["privacy_consent"]})},n})();t.PrivacyConsentPlatformSingleton=C,t.PrivacyConsentPlatform=new C,t.moduleInit=function(e){if(!t.PrivacyConsentPlatform.config){var o=n.unpackProto(e,s.privacy_consent.PrivacyConsentInitData);t.PrivacyConsentPlatform.init(o)}},t.initialize_module=function(e){t.PrivacyConsentPlatform.config||t.PrivacyConsentPlatform.init(e)}}));
//# sourceMappingURL=privacy_consent.min.js-vfl79BhTo.map